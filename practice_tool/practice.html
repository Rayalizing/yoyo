<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦Œ éº“é¸£å­—æ ¹ç»ƒä¹ å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen">
    <!-- ä¾§è¾¹æ  -->
    <div id="sidebar" class="sidebar collapsed">
        <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
        <div class="sidebar-header">
            <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" onclick="toggleSidebar()">
                <span class="sidebar-toggle-icon">â®</span>
            </button>
            <h3 class="sidebar-title">è®¾ç½®</h3>
        </div>
        
        <!-- ä¾§è¾¹æ å†…å®¹ -->
        <div class="sidebar-content">
            <!-- ä¸»é¢˜åˆ‡æ¢ -->
            <button class="sidebar-btn" id="theme-toggle-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <span class="sidebar-btn-icon" id="theme-icon">ğŸŒ™</span>
                <span class="sidebar-btn-text">ä¸»é¢˜åˆ‡æ¢</span>
            </button>
            
            <!-- ä¸“æ³¨æ¨¡å¼ -->
            <button class="sidebar-btn" id="focus-mode-btn" onclick="toggleFocusMode()" title="ä¸“æ³¨æ¨¡å¼">
                <span class="sidebar-btn-icon" id="focus-mode-icon">ğŸ‘ï¸</span>
                <span class="sidebar-btn-text">ä¸“æ³¨æ¨¡å¼</span>
            </button>
            
            <!-- è¿›åº¦ç®¡ç† -->
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">è¿›åº¦ç®¡ç†</h4>
                <button class="sidebar-btn" id="export-progress-btn" onclick="exportProgress()" title="å¯¼å‡ºè¿›åº¦">
                    <span class="sidebar-btn-icon">â</span>
                    <span class="sidebar-btn-text">å¯¼å‡ºè¿›åº¦</span>
                </button>
                <button class="sidebar-btn" id="import-progress-btn" onclick="importProgress()" title="å¯¼å…¥è¿›åº¦">
                    <span class="sidebar-btn-icon">â</span>
                    <span class="sidebar-btn-text">å¯¼å…¥è¿›åº¦</span>
                </button>
                <button class="sidebar-btn" id="load-progress-btn" onclick="loadProgressFile()" title="ä»æ–‡ä»¶åŠ è½½">
                    <span class="sidebar-btn-icon">ğŸ“</span>
                    <span class="sidebar-btn-text">ä»æ–‡ä»¶åŠ è½½</span>
                </button>
                <input type="file" id="progress-file-input" class="hidden" accept=".json">
            </div>
        </div>
    </div>
    
    <!-- ä¾§è¾¹æ é®ç½© -->
    <div id="sidebar-overlay" class="sidebar-overlay hidden" onclick="closeSidebar()"></div>
    
    <!-- å…¨å±€æç¤ºæ¡ -->
    <div id="global-toast" class="global-toast hidden">
        <span class="global-toast-icon">âœ“</span>
        <span class="global-toast-text"></span>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <main id="main-content">
        <div class="max-w-5xl mx-auto content-wrapper">
            <!-- å¤´éƒ¨logo -->
            <header class="py-4 flex items-center justify-between">
                <a href="../../" class="flex items-center gap-2 group">
                    <span class="text-2xl md:text-3xl font-serif font-black tracking-wider">
                        éº“é¸£
                    </span>
                    <span class="sm:inline-block text-sm text-muted-foreground font-light">
                        è¾“å…¥æ³•
                    </span>
                </a>
                <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
                <button class="sidebar-toggle-main" id="sidebar-toggle-main" onclick="toggleSidebar()">
                    <span>â‰¡</span>
                </button>
            </header>
            <!-- æ ‡é¢˜åŒº -->
            <div class="text-center mb-4">
                <h1 class="text-3xl md:text-4xl font-bold mb-2">
                    <span class="text-forest-primary">æŒ‡æ³•Â·å­—æ ¹</span>
                    <span id="mode-title" class="text-slate-300"> ç»ƒä¹ å·¥å…·</span>
                </h1>
            </div>
            
            <!-- æ ‡ç­¾é¡µ -->
            <div class="tab-container">
                <button onclick="switchTab('finger')" id="tab-finger" class="tab-btn active pb-2 text-lg font-medium">
                    æŒ‡æ³•ç»ƒä¹ 
                </button>
                <button onclick="switchTab('base')" id="tab-base" class="tab-btn pb-2 text-lg font-medium text-slate-400">
                    åŸºç¡€ç»ƒä¹ 
                </button>
                <button onclick="switchTab('advanced')" id="tab-advanced" class="tab-btn pb-2 text-lg font-medium text-slate-400">
                    è¿›é˜¶ç»ƒä¹ 
                </button>
            </div>
            

            
            <!-- ç»ƒä¹ å¡ç‰‡ -->
            <div class="practice-card rounded-2xl p-6 md:p-8">
                <!-- ç»Ÿè®¡æ  -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-sky-400" id="streak">0</div>
                        <div class="text-sm text-slate-400 mt-1">è¿å‡»</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-emerald-400" id="accuracy">0%</div>
                        <div class="text-sm text-slate-400 mt-1">æ­£ç¡®ç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-amber-400" id="speed">0</div>
                        <div class="text-sm text-slate-400 mt-1">é€Ÿåº¦(å­—/åˆ†)</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-purple-400" id="score">0</div>
                        <div class="text-sm text-slate-400 mt-1">å¾—åˆ†</div>
                    </div>
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div class="progress-section">
                    <div class="progress-info">
                        <div class="progress-label">å­¦ä¹ è¿›åº¦</div>
                        <div class="progress-text" id="progress-text">0/0 (0%)</div>
                    </div>
                    <div class="progress-track">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                </div>
                
                <!-- å®Œæˆå­¦ä¹ æç¤º -->
                <div id="completion-message" class="completion-overlay hidden">
                    <div class="completion-modal">
                        <div class="completion-emoji">ğŸ¦Œ</div>
                        <h2 class="completion-title">éº“é¸£ä¹‹æ—…å®Œæˆï¼</h2>
                        <p class="completion-message">ä½ å·²æˆåŠŸæŒæ¡æ‰€æœ‰å­—æ ¹ï¼</p>
                        <button onclick="resetProgress()" class="btn-reset">
                            é‡æ–°å¼€å§‹
                        </button>
                    </div>
                </div>
                
                <!-- åŸºç¡€ç»ƒä¹ æ¨¡å¼ -->
                <div id="practice-base" class="mode-content">

                    <!-- å­—æ ¹æ˜¾ç¤º -->
                    <div class="char-section">
                        <div class="char-hint" id="char-hint">è¯·è¾“å…¥è¯¥å­—æ ¹çš„ç¼–ç  (æŒ‰ç©ºæ ¼æ˜¾ç¤ºæç¤º)</div>
                        <div class="char-display mb-6 loading" id="current-char">
                            åŠ è½½ä¸­...
                        </div>
                        <!-- æç¤ºä¿¡æ¯åŒºåŸŸï¼ˆå›ºå®šä½ç½®ï¼‰ -->
                        <div class="hints-container" id="hints-container">
                            <!-- ç¼–ç æç¤ºï¼Œé¦–æ¬¡å‡ºç°æ—¶æ˜¾ç¤º -->
                            <div id="code-hint" class="code-hint">
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="input-section">
                        <div class="input-row">
                            <input type="text" id="code-input-1" 
                                class="code-input"
                                placeholder="" autocomplete="off" maxlength="2" autofocus>
                            <input type="text" id="code-input-2" 
                                class="code-input"
                                placeholder="" autocomplete="off" maxlength="1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- å­—æ ¹æ•°æ® -->
    <script src="zigen_data_module.js"></script>
    <script src="memory_logic.js"></script>
    
    <!-- é‡æ„åçš„æ¨¡å—æ–‡ä»¶ -->
    <script src="utils.js"></script>
    <script src="state_manager.js"></script>
    <script src="ui_updater.js"></script>
    <script src="input_handler.js"></script>
    <script src="base_practice.js"></script>
    
    <script>
        // ä¾§è¾¹æ åŠŸèƒ½
        let isSidebarOpen = false;
        let isFocusMode = false;
        
        // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            isSidebarOpen = !isSidebarOpen;
            
            if (isSidebarOpen) {
                sidebar.classList.remove('collapsed');
                overlay.classList.remove('hidden');
                overlay.classList.add('show');
            } else {
                sidebar.classList.add('collapsed');
                overlay.classList.remove('show');
                overlay.classList.add('hidden');
            }
        }
        
        // å…³é—­ä¾§è¾¹æ 
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            isSidebarOpen = false;
            sidebar.classList.add('collapsed');
            overlay.classList.remove('show');
            overlay.classList.add('hidden');
        }
        
        // äº®æš—ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            
            if (html.getAttribute('data-theme') === 'dark') {
                html.setAttribute('data-theme', 'light');
                themeIcon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                themeIcon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            }
            
            // åˆ‡æ¢ä¸»é¢˜åè‡ªåŠ¨æŠ˜å ä¾§æ 
            closeSidebar();
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¸»é¢˜
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                document.getElementById('theme-icon').textContent = 'ğŸŒ™';
            }
        })();
        
        // ä¸“æ³¨æ¨¡å¼åˆ‡æ¢
        function toggleFocusMode() {
            const body = document.body;
            const focusBtn = document.getElementById('focus-mode-btn');
            const focusIcon = document.getElementById('focus-mode-icon');
            
            isFocusMode = !isFocusMode;
            
            if (isFocusMode) {
                body.classList.add('focus-mode-active');
                focusBtn.classList.add('active');
                focusIcon.textContent = 'ğŸ‘ï¸';
                localStorage.setItem('focusMode', 'true');
            } else {
                body.classList.remove('focus-mode-active');
                focusBtn.classList.remove('active');
                focusIcon.textContent = 'ğŸ‘ï¸';
                localStorage.setItem('focusMode', 'false');
            }
            
            // ç‚¹å‡»ä¸“æ³¨æ¨¡å¼æŒ‰é’®åè‡ªåŠ¨æŠ˜å ä¾§æ 
            closeSidebar();
        }
        
        // å¯¼å‡ºè¿›åº¦åŠŸèƒ½
        function exportProgress() {
            try {
                // è·å–æ‰€æœ‰ç›¸å…³çš„è¿›åº¦æ•°æ®
                const progressData = {
                    state: StateManager.getState(),
                    memoryLogic: memoryLogic.getProgress(),
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                const jsonString = JSON.stringify(progressData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rime-zigen-progress-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤ºæ¡
                showToast('è¿›åº¦å¯¼å‡ºæˆåŠŸï¼');
                
                // å¯¼å‡ºæˆåŠŸåè‡ªåŠ¨æŠ˜å ä¾§æ 
                closeSidebar();
            } catch (error) {
                console.error('å¯¼å‡ºè¿›åº¦å¤±è´¥:', error);
                showToast('å¯¼å‡ºè¿›åº¦å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
            }
        }
        
        // å¯¼å…¥è¿›åº¦åŠŸèƒ½
        function importProgress() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const progressData = JSON.parse(e.target.result);
                        
                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (!progressData.state || !progressData.memoryLogic) {
                            throw new Error('æ— æ•ˆçš„è¿›åº¦æ–‡ä»¶æ ¼å¼');
                        }
                        
                        // æ¢å¤çŠ¶æ€
                        memoryLogic.restoreProgress(progressData.memoryLogic);
                        
                        // æ›´æ–°StateManagerçš„å½“å‰æ¨¡å¼å’Œè¿›åº¦
                        const currentMode = memoryLogic.currentMode;
                        if (currentMode) {
                            StateManager.updatePracticeMode(currentMode);
                        } else {
                            // æ¢å¤StateManagerçš„çŠ¶æ€
                            StateManager.updateState(progressData.state);
                        }
                        
                        // é‡æ–°åˆå§‹åŒ–ç»ƒä¹ 
                        BasePractice.initBasePractice();
                        
                        // æ›´æ–°UI
                        UIUpdater.updateStats();
                        UIUpdater.updateProgressBar();
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤ºæ¡
                        showToast('è¿›åº¦å¯¼å…¥æˆåŠŸï¼');
                        
                        // å¯¼å…¥æˆåŠŸåè‡ªåŠ¨æŠ˜å ä¾§æ 
                        closeSidebar();
                    } catch (error) {
                        console.error('å¯¼å…¥è¿›åº¦å¤±è´¥:', error);
                        showToast('å¯¼å…¥è¿›åº¦å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // ä»æœ¬åœ°æ–‡ä»¶åŠ è½½è¿›åº¦
        function loadProgressFile() {
            const input = document.getElementById('progress-file-input');
            input.click();
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const progressData = JSON.parse(e.target.result);
                        
                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (!progressData.state || !progressData.memoryLogic) {
                            throw new Error('æ— æ•ˆçš„è¿›åº¦æ–‡ä»¶æ ¼å¼');
                        }
                        
                        // æ¢å¤çŠ¶æ€
                        memoryLogic.restoreProgress(progressData.memoryLogic);
                        
                        // æ›´æ–°StateManagerçš„å½“å‰æ¨¡å¼å’Œè¿›åº¦
                        const currentMode = memoryLogic.currentMode;
                        if (currentMode) {
                            StateManager.updatePracticeMode(currentMode);
                        } else {
                            // æ¢å¤StateManagerçš„çŠ¶æ€
                            StateManager.updateState(progressData.state);
                        }
                        
                        // é‡æ–°åˆå§‹åŒ–ç»ƒä¹ 
                        BasePractice.initBasePractice();
                        
                        // æ›´æ–°UI
                        UIUpdater.updateStats();
                        UIUpdater.updateProgressBar();
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤ºæ¡
                        showToast('è¿›åº¦åŠ è½½æˆåŠŸï¼');
                        
                        // åŠ è½½æˆåŠŸåè‡ªåŠ¨æŠ˜å ä¾§æ 
                        closeSidebar();
                    } catch (error) {
                        console.error('åŠ è½½è¿›åº¦å¤±è´¥:', error);
                        showToast('åŠ è½½è¿›åº¦å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚');
                    }
                };
                
                reader.readAsText(file);
            };
        }
        
        // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸“æ³¨æ¨¡å¼çŠ¶æ€
        (function initFocusMode() {
            const savedFocusMode = localStorage.getItem('focusMode');
            if (savedFocusMode === 'true') {
                toggleFocusMode();
            }
        })();
        
        // æ˜¾ç¤ºå…¨å±€æç¤ºæ¡
        function showToast(message) {
            const toast = document.getElementById('global-toast');
            const toastText = document.querySelector('.global-toast-text');
            
            toastText.textContent = message;
            
            // æ˜¾ç¤ºæç¤ºæ¡
            toast.classList.remove('hidden');
            toast.classList.add('show');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, 3000);
        }
        
        // å…¨å±€å‡½æ•°ï¼Œä¾›HTMLå…ƒç´ ç›´æ¥è°ƒç”¨
        function switchTab(mode) {
            BasePractice.switchTab(mode);
        }
        
        // ä¸ºä¾§è¾¹æ æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶ç›‘å¬å™¨ï¼Œå®ç°è‡ªåŠ¨æŠ˜å 
        document.getElementById('sidebar').addEventListener('mouseleave', function() {
            closeSidebar();
        });
        
        // é‡ç½®è¿›åº¦å‡½æ•°
        function resetProgress() {
            // éšè—å®Œæˆä¿¡æ¯
            const completionMessage = document.getElementById('completion-message');
            if (completionMessage) {
                completionMessage.classList.add('hidden');
            }
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            StateManager.resetState();
            memoryLogic.reset(false);
            
            // é‡æ–°åˆå§‹åŒ–ç»ƒä¹ 
            BasePractice.initBasePractice();
            
            // æ›´æ–°UI
            UIUpdater.updateStats();
            UIUpdater.updateProgressBar();
        }
    </script>
</body>
</html>